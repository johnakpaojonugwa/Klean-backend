import Branch from "../models/branch.model.js";
import User from "../models/user.model.js";
import { sendResponse, sendError } from "../utils/response.js";
import { logger } from "../utils/logger.js";

export const createBranch = async (req, res, next) => {
    try {
        const { name, address, email, contactNumber, manager, servicesOffered, operatingHours } = req.body;

        // 1. Simplified Validation
        // Since branchCode is now autogenerated, we primarily check for the unique name.
        const existingBranch = await Branch.findOne({ name });
        if (existingBranch) {
            return sendError(res, 409, "Branch with this name already exists");
        }

        // 2. Manager Validation
        if (manager) {
            const managerUser = await User.findById(manager);
            if (!managerUser) {
                return sendError(res, 404, "Manager user not found");
            }
        }

        // 3. Create the Branch
        // We omit branchCode here; Mongoose will generate it before validating/saving.
        const branch = await Branch.create({
            name,
            address,
            email,
            contactNumber,
            manager,
            servicesOffered,
            operatingHours
        });

        logger.info(`Branch created: ${branch.name} (${branch.branchCode})`);
        return sendResponse(res, 201, true, "Branch created successfully", { branch });
    } catch (error) {
        logger.error("Create branch error:", error.message);
        next(error);
    }
};

export const getAllBranches = async (req, res, next) => {
    try {
        const { isActive, page = 1, limit = 10 } = req.query;

        let query = {};
        if (isActive !== undefined) {
            query.isActive = isActive === 'true';
        }

        const skip = (page - 1) * limit;
        const branches = await Branch.find(query)
            .populate('manager', 'fullname email')
            .limit(parseInt(limit))
            .skip(skip)
            .sort({ createdAt: -1 });

        const total = await Branch.countDocuments(query);

        logger.info(`Branches fetched: ${branches.length}`);
        return sendResponse(res, 200, true, "Branches retrieved", {
            branches,
            pagination: { total, page: parseInt(page), pages: Math.ceil(total / limit) }
        });
    } catch (error) {
        logger.error("Get all branches error:", error.message);
        next(error);
    }
};

export const getBranchById = async (req, res, next) => {
    try {
        const { branchId } = req.params;

        const branch = await Branch.findById(branchId).populate('manager', 'fullname email');

        if (!branch) {
            return sendError(res, 404, "Branch not found");
        }

        return sendResponse(res, 200, true, "Branch retrieved", { branch });
    } catch (error) {
        logger.error("Get branch error:", error.message);
        next(error);
    }
};

export const updateBranch = async (req, res, next) => {
    try {
        const { branchId } = req.params;
        const updates = req.body;

        // Find the branch first
        const branch = await Branch.findById(branchId);

        if (!branch) {
            return sendError(res, 404, "Branch not found");
        }

        // Apply updates to the branch object
        // This allows the pre-validate hook to "see" the changes
        const allowedUpdates = ['name', 'email', 'address', 'contactNumber', 'manager', 'isActive', 'servicesOffered', 'operatingHours'];

        Object.keys(updates).forEach((key) => {
            if (allowedUpdates.includes(key)) {
                branch[key] = updates[key];
            }
        });

        // If the name changed, we clear the branchCode so the hook regenerates it
        if (updates.name) {
            branch.branchCode = undefined;
        }

        // Save the document
        // This triggers the 'pre-validate' hook and all schema validations
        await branch.save();

        // Populate manager info after saving
        await branch.populate('manager', 'fullname email');

        logger.info(`Branch updated: ${branch.name} (${branch.branchCode})`);
        return sendResponse(res, 200, true, "Branch updated successfully", { branch });
    } catch (error) {
        logger.error("Update branch error:", error.message);
        next(error);
    }
};

export const deleteBranch = async (req, res, next) => {
    try {
        const { branchId } = req.params;

        const branch = await Branch.findByIdAndDelete(branchId);

        if (!branch) {
            return sendError(res, 404, "Branch not found");
        }

        logger.info(`Branch deleted: ${branch.name}`);
        return sendResponse(res, 200, true, "Branch deleted successfully");
    } catch (error) {
        logger.error("Delete branch error:", error.message);
        next(error);
    }
};
